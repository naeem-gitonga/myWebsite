include:
  - '/backend/apis/.gitlab-ci.yml'
  - '/backend/cdk/.gitlab-ci.yml'

image: node:20.11.1

stages:
  - test
  - build
  - test-cdk
  - deploy

.common_setup: &common_setup
  - cd backend/cdk
  - npm i
  - npm i -g aws-cdk typescript ts-node
  - aws sts get-caller-identity

.install-aws: &install-aws
  - apt update
  - apt install -y jq
  - curl -k "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
  - unzip "awscliv2.zip"
  - ./aws/install

.authenticate-aws: &authenticate-aws
  - export CREDS=`aws sts assume-role --duration-seconds 10800 --role-session-name "gitlab-devops-${CI_PIPELINE_ID}" --role-arn arn:aws:iam::${AWS_ACCOUNT_NUMBER}:role/mywebsite-devops`
  - export AWS_ACCESS_KEY_ID=`echo $CREDS | jq -r .Credentials.AccessKeyId`
  - export AWS_SECRET_ACCESS_KEY=`echo $CREDS | jq -r .Credentials.SecretAccessKey`
  - export AWS_SESSION_TOKEN=`echo $CREDS | jq .Credentials.SessionToken`
  - export AWS_DEFAULT_REGION="${AWS_REGION}"
  - echo $AWS_SESSION_TOKEN

deploy_frontend_staging:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - app/**/*
        - components/**/*
        - hooks/**/*
        - pages/**/*
        - types/**/*
        - utils/**/*
        - next.config.js
        - package.json
        - vercel.json
    - changes:
      - /backend/apis/**/*
      - /backend/cdk/**/*
      when: never
  script:
    - curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_XVrzM2eALvquKAUKMDAlgjSccy4B/cGxMEW1fLT

deploy_frontend_production:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - app/**/*
        - components/**/*
        - hooks/**/*
        - pages/**/*
        - types/**/*
        - utils/**/*
        - next.config.js
        - package.json
        - vercel.json
    - changes:
      - /backend/apis/**/*
      - /backend/cdk/**/*
      when: never
  script:
    - curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_XVrzM2eALvquKAUKMDAlgjSccy4B/k4eiYJ4iju
