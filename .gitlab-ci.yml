include:
  - '/backend/apis/.gitlab-ci.yml'
  - '/backend/cdk/.gitlab-ci.yml'

image: node:20.11.1

stages:
  - test
  - build
  - test-cdk
  - deploy

.common_setup: &common_setup
  - cd backend/cdk
  - npm i
  - npm i -g aws-cdk typescript ts-node
  - aws sts get-caller-identity

.install-aws: &install-aws
  - apt update
  - apt install -y jq
  - curl -k "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
  - unzip "awscliv2.zip"
  - ./aws/install

.authenticate-aws: &authenticate-aws
  - export CREDS=`aws sts assume-role --duration-seconds 10800 --role-session-name "gitlab-devops-${CI_PIPELINE_ID}" --role-arn arn:aws:iam::${AWS_ACCOUNT_NUMBER}:role/mywebsite-devops`
  - export AWS_ACCESS_KEY_ID=`echo $CREDS | jq -r .Credentials.AccessKeyId`
  - export AWS_SECRET_ACCESS_KEY=`echo $CREDS | jq -r .Credentials.SecretAccessKey`
  - export AWS_SESSION_TOKEN=`echo $CREDS | jq .Credentials.SessionToken`
  - export AWS_DEFAULT_REGION="${AWS_REGION}"
  - echo $AWS_SESSION_TOKEN
