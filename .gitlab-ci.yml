include:
  - '/backend/apis/.gitlab-ci.yml'
  - '/backend/cdk/.gitlab-ci.yml'

image: node:20.11.1

stages:
  - test
  - build
  - test-cdk
  - deploy

deploy_frontend_staging:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - app/**/*
        - components/**/*
        - hooks/**/*
        - pages/**/*
        - types/**/*
        - utils/**/*
        - next.config.js
        - package.json
        - vercel.json
    - changes:
      - /backend/apis/**/*
      - /backend/cdk/**/*
      when: never
  script:
    - curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_XVrzM2eALvquKAUKMDAlgjSccy4B/cGxMEW1fLT

deploy_frontend_production:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - app/**/*
        - components/**/*
        - hooks/**/*
        - pages/**/*
        - types/**/*
        - utils/**/*
        - next.config.js
        - package.json
        - vercel.json
    - changes:
      - /backend/apis/**/*
      - /backend/cdk/**/*
      when: never
  script:
    - curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_XVrzM2eALvquKAUKMDAlgjSccy4B/k4eiYJ4iju
